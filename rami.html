<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Egér alkatrész kezelő</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
    body {
      font-family: 'Roboto', sans-serif;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .custom-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
  </style>
</head>
<body class="bg-gray-50">
  <main id="mainPage" class="p-6">
    <h1 class="text-2xl font-bold mb-4">Egér alkatrész kezelő</h1>

    <form id="addPartForm" class="grid gap-4 mb-6">
      <input id="partName" type="text" placeholder="Alkatrész neve" required class="border p-2 rounded" />
      <label for="alkatreszTipus">Típus:</label>
<select id="alkatreszTipus" name="alkatreszTipus">
   <option value="" disabled selected>Válassz</option>
  <option value="mikrokapcsolo_3pin">Mikrokapcsoló 3 pin</option>
  <option value="mikrokapcsolo_2pin_moddolhato">Mikrokapcsoló 2 pin - 7.3mm-ből moddolható 5.2mm és 9.2mm is!</option>
  <option value="smd_mikrokapcsolo_2pin">SMD mikrokapcsoló 2 pin (pl. oldalsó gombra)</option>
  <option value="smd_mikrokapcsolo_4pin">SMD mikrokapcsoló 4 pin</option>
  <option value="eger_talp_univerzalis_ptfe">Egértalp, univerzális - tömör PTFE, lekerekített szélű</option>
  <option value="eger_talp_meretre_vagott_ptfe">Egértalp, méretre vágott - tömör PTFE, lekerekített szélű</option>
  <option value="gorgo_encoder">Görgő, Encoder (mindegyik magasítható alátéttel + 0,5 / 1 / 1,5mm-rel!)</option>
  <option value="parakabel_550">Parakábel 550, univerzális - Kérhető JST PH 2.0, Micro USB és Type-C csatlakozóval is!</option>
  <option value="usb_atalakito">USB átalakító</option>
  <option value="wireless">Wireless</option>
  <option value="akkumulator">Akkumulátor - BÁRMILYEN csatlakozóval kérhető!</option>
  <option value="grip_univerzalis_diy">Grip - univerzális, DIY</option>
  <option value="billentyuzet_alkatreszek">Billentyűzet alkatrészek</option>
  <option value="kontroller_alkatreszek">Kontroller alkatrészek</option>
</select>

      <input id="kit" type="number" placeholder="Készlet szám" required class="border p-2 rounded" />
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Hozzáadás</button>
    </form>

    <div class="flex gap-4">
  <button onclick="showPartsList()" class="bg-gray-700 text-white px-4 py-2 rounded">Alkatrészek listája</button>
  <button onclick="showWorksheetGenerator()" class="bg-green-700 text-white px-4 py-2 rounded">Munkalap generálása</button>
  <button onclick="location.href='worksheet.html'" class="bg-blue-700 text-white px-4 py-2 rounded">Munkalapok megtekintése</button>
</div>

  </main>

  <section id="partsListPage" class="hidden p-6">
    <h2 class="text-xl font-bold mb-4">Alkatrészek listája</h2>
    <table class="min-w-full bg-white rounded shadow">
      <thead>
        <tr class="bg-gray-100 text-left">
          <th class="px-6 py-3">Név</th>
          <th class="px-6 py-3">Típus</th>
          
          <th class="px-6 py-3">Készlet</th>
         
        </tr>
      </thead>
      <tbody id="partsTableBody"></tbody>
    </table>
    <button onclick="backToMain()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded">Vissza</button>
  </section>

  <section id="worksheetPage" class="hidden p-6">
    <h2 class="text-xl font-bold mb-4">Munkalap generálása</h2>
    <form id="worksheetForm" class="grid gap-4 mb-6">
        <!-- HTML: a munkalap generálás oldal tetején -->
        <label for="errorReason" class="block font-semibold mb-1">Hiba leírás:</label>
        <input type="text" id="errorReason" class="w-full p-2 border rounded mb-4" required />
         <div>
        <label for="kitDropdown" class="block font-semibold mb-1">Alkatrész kiválasztása</label>
        <select id="kitDropdown" class="border p-2 rounded w-full">
          <option value="">Válassz alkatrészt...</option>
        </select>
        <div id="selectedPartsList" class="mt-2 flex flex-wrap gap-2"></div>
      </div>
      <input id="customerName" type="text" placeholder="ProHardver Név" required class="border p-2 rounded" />
      <input id="simpleCustomerName" type="text" placeholder="Név" class="border p-2 rounded" />

      <input id="contactInfo" type="text" placeholder="Elérhetőség (pl. telefonszám, email)" required class="border p-2 rounded" />

      <input id="deviceToRepair" type="text" placeholder="Javítandó eszköz" required class="border p-2 rounded" />
      <input id="repairDate" type="date" required class="border p-2 rounded" />
      <textarea id="comment" placeholder="Megjegyzés" class="border p-2 rounded"></textarea>
      <button type="button" onclick="generateWorksheet()" class="bg-blue-700 text-white px-4 py-2 rounded">Munkalap generálása</button>
    </form>

    <div id="worksheetPreview" class="hidden bg-white p-4 rounded shadow">
      <div id="worksheetContent"></div>
    </div>
    <button onclick="backToMain()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded">Vissza</button>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      getDoc,
      addDoc,
      deleteDoc,
      doc,
      updateDoc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBlDTpa3kV6-QFO-toYRO6DiS5-88WAwQk",
      authDomain: "eger-kezelo.firebaseapp.com",
      projectId: "eger-kezelo",
      storageBucket: "eger-kezelo.firebasestorage.app",
      messagingSenderId: "1076613883619",
      appId: "1:1076613883619:web:64b94cca3880a89da987d6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const partsCollection = collection(db, "parts");

    document.getElementById('addPartForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const partName = document.getElementById('partName').value;
  const tipus = document.getElementById('alkatreszTipus').value;  // a selectből
  const kit = parseInt(document.getElementById('kit').value);

  if (!partName || !tipus || isNaN(kit)) {
    alert("Kérlek, tölts ki minden mezőt helyesen!");
    return;
  }

  try {
    await addDoc(partsCollection, { partName, tipus, kit });
    alert("Alkatrész hozzáadva!");
    this.reset();
  } catch (error) {
    alert("Hiba történt az alkatrész hozzáadása során: " + error.message);
  }
});


   async function loadPartsTable() {
  const tableBody = document.getElementById('partsTableBody');
  tableBody.innerHTML = '';
  const snapshot = await getDocs(partsCollection);
  if (snapshot.empty) {
    tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Nincsenek alkatrészek</td></tr>';
    return;
  }
  snapshot.forEach(docSnap => {
    const part = docSnap.data();
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="px-6 py-4 whitespace-nowrap">${part.partName}</td>
      <td class="px-6 py-4 whitespace-nowrap">${part.tipus}</td>
      <td class="px-6 py-4 whitespace-nowrap">${part.kit}</td>
      <td class="px-6 py-4 whitespace-nowrap flex gap-2 items-center">
        <button onclick="changeKit('${docSnap.id}', 1)" class="text-green-600 hover:text-green-900 font-bold px-2 rounded border border-green-600">+</button>
        <button onclick="deletePart('${docSnap.id}')" class="text-red-600 hover:text-red-900">Törlés</button>
        <button onclick="changeKit('${docSnap.id}', -1)" class="text-orange-600 hover:text-orange-900 font-bold px-2 rounded border border-orange-600">-</button>
      </td>
    `;
    tableBody.appendChild(row);
  });
}

// Készlet módosító függvény (+1 vagy -1)
async function changeKit(partId, delta) {
  const partRef = doc(db, "parts", partId);
  const partSnap = await getDoc(partRef);
  if (!partSnap.exists()) {
    alert("Az alkatrész nem található.");
    return;
  }
  const currentKit = partSnap.data().kit || 0;
  const newKit = currentKit + delta;

  if (newKit < 0) {
    alert("A készlet nem lehet negatív!");
    return;
  }

  await updateDoc(partRef, { kit: newKit });
  loadPartsTable();  // újratöltjük a táblázatot a friss készletértékekkel
}

    
    window.deletePart = async function (id) {
      if (confirm("Biztosan törlöd?")) {
        await deleteDoc(doc(db, "parts", id));
        loadPartsTable();
      }
    };

    const selectedPartNames = new Set();

    async function loadKitSelect() {
      const dropdown = document.getElementById("kitDropdown");
      dropdown.innerHTML = '<option value="">Válassz alkatrészt...</option>';

      const snapshot = await getDocs(partsCollection);
      const partNames = new Set();

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        partNames.add(data.partName);
      });

      partNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        dropdown.appendChild(option);
      });

      dropdown.onchange = function () {
        const selected = dropdown.value;
        if (selected && !selectedPartNames.has(selected)) {
          selectedPartNames.add(selected);
          renderSelectedParts();
        }
        dropdown.value = "";
      };
    }

    function renderSelectedParts() {
      const container = document.getElementById("selectedPartsList");
      container.innerHTML = "";

      selectedPartNames.forEach(name => {
        const item = document.createElement("div");
        item.className = "bg-blue-100 text-blue-800 px-3 py-1 rounded flex items-center";
        const span = document.createElement("span");
        span.textContent = name;
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "×";
        removeBtn.className = "ml-2 text-red-500 hover:text-red-700 font-bold";
        removeBtn.onclick = () => {
          selectedPartNames.delete(name);
          renderSelectedParts();
        };
        item.appendChild(span);
        item.appendChild(removeBtn);
        container.appendChild(item);
      });
    }

window.generateWorksheet = async function () {
  const form = document.getElementById('worksheetForm');
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }
  const contactInfo = document.getElementById('contactInfo').value;
  const errorReason = document.getElementById('errorReason').value;
  const customerName = document.getElementById('customerName').value;
  const simpleCustomerName = document.getElementById('simpleCustomerName').value;
  const deviceToRepair = document.getElementById('deviceToRepair').value;
  const repairDate = document.getElementById('repairDate').value;
  const comment = document.getElementById('comment').value;

  const usedParts = [];

  // Készlet ellenőrzése és csökkentése
  for (const name of selectedPartNames) {
    const q = query(partsCollection, where("partName", "==", name));
    const snapshot = await getDocs(q);
    if (!snapshot.empty) {
      const docSnap = snapshot.docs[0];
      const part = docSnap.data();

      if (part.kit > 0) {
        const newKit = part.kit - 1;
        await updateDoc(doc(db, "parts", docSnap.id), { kit: newKit });
        usedParts.push(part);
      } else {
        alert(`Nincs elegendő készlet a(z) ${part.partName} alkatrészből! A munkalap generálás megszakítva.`);
        return;
      }
    }
  }

  // Munkalap adatainak mentése Firestore-ba
  try {
    await addDoc(collection(db, "worksheets"), {
      errorReason,
      contactInfo,
      customerName,
      simpleCustomerName,
      deviceToRepair,
      repairDate,
      comment,
      usedParts,
      status: "Szállítás alatt",
      createdAt: new Date()
    });
    alert("Munkalap sikeresen elmentve a Firebase-be!");
    
    // Űrlap és kiválasztott alkatrészek törlése
    form.reset();
    selectedPartNames.clear();
    renderSelectedParts();
  } catch (error) {
    alert("Hiba történt a munkalap mentése során: " + error.message);
  }
};




    window.onload = () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('repairDate').value = today;
    };

    window.loadPartsTable = loadPartsTable;
    window.changeKit = changeKit;
    window.loadKitSelect = loadKitSelect;
    window.showPartsList = function () {
      document.getElementById('mainPage').classList.add('hidden');
      document.getElementById('partsListPage').classList.remove('hidden');
      loadPartsTable();
    };
    window.showWorksheetGenerator = function () {
      document.getElementById('mainPage').classList.add('hidden');
      document.getElementById('worksheetPage').classList.remove('hidden');
      loadKitSelect();
    };
    window.backToMain = function () {
      document.getElementById('mainPage').classList.remove('hidden');
      document.getElementById('partsListPage').classList.add('hidden');
      document.getElementById('worksheetPage').classList.add('hidden');
      document.getElementById('worksheetPreview').classList.add('hidden');
    };
  </script>
</body>
</html>
